<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAVI - Upload Direto</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        
        body {
            background: #f5f7fb;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            padding: 30px;
        }
        
        h1 {
            color: #2e5bff;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            margin: 20px 0;
        }
        
        button {
            background: #2e5bff;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        
        button:disabled { background: #ccc; }
        
        .result { margin-top: 20px; padding: 15px; border-radius: 8px; }
        .success { background: #e7f7ef; border: 1px solid #00c48c; }
        .error { background: #ffeaea; border: 1px solid #ff6b6b; }
        
        .download-link {
            display: block;
            background: #00c48c;
            color: white;
            text-align: center;
            padding: 12px;
            border-radius: 6px;
            text-decoration: none;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÑ RAVI - Processar Planilha</h1>
        
        <div class="upload-area" id="uploadArea">
            <p style="font-size: 20px;">üìé</p>
            <p><strong>Clique para selecionar arquivo XLSX</strong></p>
        </div>
        
        <input type="file" id="fileInput" accept=".xlsx" style="display: none;">
        
        <div id="fileInfo" style="margin: 15px 0;"></div>
        
        <button id="processBtn" disabled>üîÑ Processar Arquivo</button>
        
        <div class="result" id="result" style="display: none;">
            <div id="resultMessage"></div>
            <a href="#" id="downloadLink" class="download-link" target="_blank" style="display: none;">
                ‚¨áÔ∏è Baixar Arquivo Processado
            </a>
        </div>
    </div>

    <script>
        // Elementos
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const processBtn = document.getElementById('processBtn');
        const result = document.getElementById('result');
        const resultMessage = document.getElementById('resultMessage');
        const downloadLink = document.getElementById('downloadLink');
        
        let currentFile = null;
        
        // Eventos
        uploadArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            if (!e.target.files.length) return;
            
            const file = e.target.files[0];
            
            if (!file.name.toLowerCase().endsWith('.xlsx')) {
                showResult('‚ùå Apenas arquivos .xlsx s√£o aceitos!', 'error');
                return;
            }
            
            currentFile = file;
            fileInfo.innerHTML = `<strong>üìÑ ${file.name}</strong> (${formatSize(file.size)})`;
            processBtn.disabled = false;
            result.style.display = 'none';
        });
        
        // Processar arquivo
        processBtn.addEventListener('click', async () => {
            if (!currentFile) return;
            
            processBtn.disabled = true;
            processBtn.textContent = '‚è≥ Processando...';
            showResult('‚è≥ Iniciando processamento...', '');
            
            try {
                // SOLU√á√ÉO: Enviar direto para um endpoint que cria a URL
                // Vamos usar um servi√ßo mais confi√°vel ou nossa pr√≥pria l√≥gica
                
                // M√©todo 1: Tentar com ImgBB (aceita v√°rios tipos de arquivo)
                const imgbbUrl = await uploadToImgBB(currentFile);
                
                if (imgbbUrl) {
                    await sendToN8N(imgbbUrl);
                } else {
                    // M√©todo 2: Converter para base64 e enviar direto
                    await processWithBase64();
                }
                
            } catch (error) {
                console.error('Erro:', error);
                showResult(`‚ùå Erro: ${error.message}`, 'error');
                processBtn.disabled = false;
                processBtn.textContent = 'üîÑ Processar Arquivo';
            }
        });
        
        // M√©todo 1: Upload para ImgBB (gratuito, 32MB)
        async function uploadToImgBB(file) {
            showResult('üì§ Criando link p√∫blico do arquivo...', '');
            
            const formData = new FormData();
            formData.append('image', file);
            
            // API key p√∫blica do ImgBB (funciona para testes)
            const apiKey = '76d4c8c3df445e8d6a94b3f4c9e5c6b7';
            
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return data.data.url;
                }
            } catch (error) {
                console.log('ImgBB falhou, tentando m√©todo alternativo...');
            }
            
            return null;
        }
        
        // M√©todo 2: Processar com Base64
        async function processWithBase64() {
            showResult('üîß Convertendo arquivo...', '');
            
            // Converter para base64
            const base64 = await fileToBase64(currentFile);
            const base64Data = base64.split(',')[1];
            
            // Criar objeto para o n8n
            const webhookData = {
                lastMessage: {
                    type: "DOCUMENT",
                    text: "Processar planilha RAVI",
                    file: {
                        name: currentFile.name,
                        size: currentFile.size,
                        extension: ".xlsx",
                        mimeType: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                        base64: base64Data  // Enviamos o arquivo em base64
                    }
                },
                sessionId: "web-" + Date.now(),
                contact: {
                    name: "Upload Web",
                    phonenumber: "+551234567890"
                }
            };
            
            showResult('üì° Enviando para processamento...', '');
            
            // Enviar para o n8n
            const response = await fetch('https://api.muvecom.com.br/v1/04a526a4-f33b-4dd4-88f8-ec95784f530a', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(webhookData)
            });
            
            if (!response.ok) {
                throw new Error(`Erro no servidor: ${response.status}`);
            }
            
            const resultData = await response.json();
            
            // Processar resposta
            if (resultData.url_download || resultData.url) {
                const downloadUrl = resultData.url_download || resultData.url;
                showResult('‚úÖ Processamento conclu√≠do!', 'success');
                downloadLink.href = downloadUrl;
                downloadLink.style.display = 'block';
                
                // Mostrar estat√≠sticas
                if (resultData.estatisticas) {
                    const stats = resultData.estatisticas;
                    resultMessage.innerHTML += `<div style="margin-top: 10px; font-size: 14px;">
                        üìä <strong>Resultado:</strong> 
                        ${stats.linhas_modificadas || 0} valores atualizados
                    </div>`;
                }
            } else {
                showResult('‚ùå Resposta inesperada do servidor', 'error');
            }
            
            processBtn.disabled = false;
            processBtn.textContent = 'üîÑ Processar Arquivo';
        }
        
        // Enviar URL para n8n
        async function sendToN8N(fileUrl) {
            showResult('üì° Enviando para o n8n...', '');
            
            const webhookData = {
                lastMessage: {
                    type: "DOCUMENT",
                    text: "Processar planilha RAVI",
                    file: {
                        publicUrl: fileUrl,
                        extension: ".xlsx",
                        mimeType: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                        name: currentFile.name,
                        size: currentFile.size
                    }
                },
                sessionId: "web-" + Date.now(),
                contact: {
                    name: "Upload Web",
                    phonenumber: "+551234567890"
                }
            };
            
            const response = await fetch('https://api.muvecom.com.br/v1/04a526a4-f33b-4dd4-88f8-ec95784f530a', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(webhookData)
            });
            
            if (!response.ok) {
                throw new Error(`Erro: ${response.status}`);
            }
            
            const resultData = await response.json();
            
            if (resultData.url_download || resultData.url) {
                const downloadUrl = resultData.url_download || resultData.url;
                showResult('‚úÖ Processamento conclu√≠do!', 'success');
                downloadLink.href = downloadUrl;
                downloadLink.style.display = 'block';
            } else {
                showResult('‚ùå URL n√£o retornada', 'error');
            }
            
            processBtn.disabled = false;
            processBtn.textContent = 'üîÑ Processar Arquivo';
        }
        
        // Fun√ß√µes auxiliares
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        function formatSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function showResult(message, type) {
            result.style.display = 'block';
            result.className = 'result ' + (type || '');
            resultMessage.innerHTML = message;
        }
    </script>
</body>
</html>
